{% extends 'base.html.twig' %}

{% block title %}{{ world.name }}{% endblock %}

{% block body %}
<div class="world-show-wrapper text-light py-5">
  <div class="container">
    <h1 class="text-center mb-4 fw-bold">World</h1>

    <div class="row justify-content-center g-4">

      {# --- Bloc principal : infos du monde --- #}
      <div class="col-lg-8">
        <div class="world-details-card p-4">
          <div class="d-flex align-items-start justify-content-between">
            <div class="d-flex align-items-start gap-3">
              <img 
                src="{{ asset(world.image ? 'uploads/world_images/' ~ world.image : 'uploads/world_images/default.png') }}"
                alt="{{ world.name }}"
                class="world-cover-img"
              >
              <div>
                <h3 class="fw-bold mb-2">{{ world.name }}</h3>
                <p class="small mb-3">{{ world.description|default('No description provided.') }}</p>

                {# ✅ Bouton Quitter le monde (visible si pas créateur) #}
                {% if app.user and world.createdBy.id != app.user.id %}
                  <form action="{{ path('app_world_remove_member', { id: world.id, userId: app.user.id }) }}" 
                        method="POST" 
                        class="leave-world-form">
                    <button type="submit" class="btn-leave-world">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" 
                           fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
                           stroke-linejoin="round" class="lucide lucide-log-out">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" x2="9" y1="12" y2="12"/>
                      </svg>
                      Leave World
                    </button>
                  </form>
                {% endif %}
              </div>
            </div>

            {% if app.user and world.getRoleForUser(app.user) == 'ADMIN' %}
              <a href="{{ path('app_world_admin', { id: world.id }) }}" class="btn-settings" title="World settings">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="22" height="22">
                  <path d="M19.43 12.98c.04-.32.07-.65.07-.98s-.03-.66-.07-.98l2.11-1.65a.5.5 0 00.12-.63l-2-3.46a.5.5 0 00-.6-.22l-2.49 1a7.03 7.03 0 00-1.7-.98l-.38-2.65A.488.488 0 0014 2h-4a.488.488 0 00-.49.42l-.38 2.65c-.63.25-1.21.58-1.7.98l-2.49-1a.5.5 0 00-.6.22l-2 3.46a.5.5 0 00.12.63l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65a.5.5 0 00-.12.63l2 3.46c.14.25.43.34.68.22l2.49-1c.49.4 1.07.73 1.7.98l.38 2.65c.04.24.24.42.49.42h4c.25 0 .45-.18.49-.42l.38-2.65c.63-.25 1.21-.58 1.7-.98l2.49 1c.25.12.54.03.68-.22l2-3.46a.5.5 0 00-.12-.63l-2.11-1.65zM12 15.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7z"/>
                </svg>
              </a>
            {% endif %}
          </div>
        </div>
      </div>

      {# --- Bloc utilisateurs --- #}
      <div class="col-lg-3">
        <div class="world-users-card p-4">
          <h4 class="fw-bold mb-3 text-center">Users</h4>

          {% if app.user %}
            {% set currentRole = null %}
            {% for wur in world.worldUserRoles %}
              {% if wur.user == app.user %}
                {% set currentRole = wur.role %}
              {% endif %}
            {% endfor %}

            {% if currentRole in ['ADMIN', 'MODERATOR'] %}
              <form action="{{ path('app_world_add_member', { id: world.id }) }}" method="POST" class="d-flex mb-3">
                <select name="friend_id" class="form-select user-select-input">
                  <option value="">Select a friend...</option>
                  {% for friend in friends %}
                    {% set alreadyInWorld = false %}
                    {% for wur in world.worldUserRoles %}
                      {% if wur.user.id == friend.id %}
                        {% set alreadyInWorld = true %}
                      {% endif %}
                    {% endfor %}
                    {% if not alreadyInWorld %}
                      <option value="{{ friend.id }}">{{ friend.username }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
                <button type="submit" class="btn-green ms-2">Add</button>
              </form>
            {% endif %}
          {% endif %}

          <ul class="list-unstyled mb-0">
            {% for wur in world.worldUserRoles %}
              {% set roleClass = '' %}
              {% if wur.role == 'ADMIN' %}
                {% set roleClass = 'role-admin' %}
              {% elseif wur.role == 'MODERATOR' %}
                {% set roleClass = 'role-moderator' %}
              {% else %}
                {% set roleClass = 'role-viewer' %}
              {% endif %}

              <li class="d-flex align-items-center mb-3">
                <img 
                  src="{{ asset(wur.user.profileImage ? 'uploads/profile_images/' ~ wur.user.profileImage : 'uploads/profile_images/default.png') }}" 
                  alt="{{ wur.user.username }}" 
                  class="user-avatar {{ roleClass }}"
                >
                <span class="ms-3">
                  {{ wur.user.username }} 
                  <small class="ms-2">({{ wur.role|capitalize }})</small>
                </span>
              </li>
            {% else %}
              <p class="text-center text-muted">No users yet.</p>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.btn-leave-world {
  background-color: #ff3b3b;
  color: white;
  border: none;
  padding: 8px 14px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
  box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
}
.btn-leave-world:hover {
  background-color: #ff0000;
  transform: scale(1.05);
  box-shadow: 0 0 16px rgba(255, 50, 50, 0.5);
}
</style>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  {{ encore_entry_script_tags('world-actions') }}
{% endblock %}
